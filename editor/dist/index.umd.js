!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("mini-canvas-core")):"function"==typeof define&&define.amd?define(["exports","mini-canvas-core"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).miniCanvasEditor={},t.miniCanvasCore)}(this,(function(t,e){"use strict";var s;function i(t,e,s,i){return new(s||(s=Promise))((function(n,o){function a(t){try{c(i.next(t))}catch(t){o(t)}}function r(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(a,r)}c((i=i.apply(t,e||[])).next())}))}t.EditorMode=void 0,(s=t.EditorMode||(t.EditorMode={})).select="select",s.rect="rect",s.circle="circle",s.brush="brush",s.textbox="textbox",s.hand="hand","function"==typeof SuppressedError&&SuppressedError;class n{static attrs(t,e){Object.keys(e).forEach((s=>{const i=e[s];t.setAttribute(s,"string"==typeof i?i:i.toString())}))}static element(t,e){const s=document.createElement(t);return e&&n.attrs(s,e),s}static div(t){return n.element("div",t)}}const o="http://www.w3.org/2000/svg";class a{static createSvg(t,e){const s=document.createElementNS(o,"svg");s.setAttribute("viewBox","0 -960 960 960"),s.classList.add(e);const i=document.createElementNS(o,"path");return i.setAttribute("d",t),s.appendChild(i),s}}a.cursor="m320-410 79-110h170L320-716v306ZM551-80 406-392 240-160v-720l560 440H516l144 309-109 51ZM399-520Z",a.rect="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm0 0v-560 560Z",a.circle="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z",a.eye="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z",a.eyeOff="m644-428-58-58q9-47-27-88t-93-32l-58-58q17-8 34.5-12t37.5-4q75 0 127.5 52.5T660-500q0 20-4 37.5T644-428Zm128 126-58-56q38-29 67.5-63.5T832-500q-50-101-143.5-160.5T480-720q-29 0-57 4t-55 12l-62-62q41-17 84-25.5t90-8.5q151 0 269 83.5T920-500q-23 59-60.5 109.5T772-302Zm20 246L624-222q-35 11-70.5 16.5T480-200q-151 0-269-83.5T40-500q21-53 53-98.5t73-81.5L56-792l56-56 736 736-56 56ZM222-624q-29 26-53 57t-41 67q50 101 143.5 160.5T480-280q20 0 39-2.5t39-5.5l-36-38q-11 3-21 4.5t-21 1.5q-75 0-127.5-52.5T300-500q0-11 1.5-21t4.5-21l-84-82Zm319 93Zm-151 75Z",a.locked="M240-80q-33 0-56.5-23.5T160-160v-400q0-33 23.5-56.5T240-640h40v-80q0-83 58.5-141.5T480-920q83 0 141.5 58.5T680-720v80h40q33 0 56.5 23.5T800-560v400q0 33-23.5 56.5T720-80H240Zm0-80h480v-400H240v400Zm240-120q33 0 56.5-23.5T560-360q0-33-23.5-56.5T480-440q-33 0-56.5 23.5T400-360q0 33 23.5 56.5T480-280ZM360-640h240v-80q0-50-35-85t-85-35q-50 0-85 35t-35 85v80ZM240-160v-400 400Z",a.close="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z",a.text="M420-160v-520H200v-120h560v120H540v520H420Z",a.image="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm40-80h480L570-480 450-320l-90-120-120 160Zm-40 80v-560 560Z",a.brush="M240-120q-45 0-89-22t-71-58q26 0 53-20.5t27-59.5q0-50 35-85t85-35q50 0 85 35t35 85q0 66-47 113t-113 47Zm0-80q33 0 56.5-23.5T320-280q0-17-11.5-28.5T280-320q-17 0-28.5 11.5T240-280q0 23-5.5 42T220-202q5 2 10 2h10Zm230-160L360-470l358-358q11-11 27.5-11.5T774-828l54 54q12 12 12 28t-12 28L470-360Zm-190 80Z",a.hand="M480-80q-133 0-226.5-93.5T160-400v-320q0-17 11.5-28.5T200-760q17 0 28.5 11.5T240-720v240h40v-400q0-17 11.5-28.5T320-920q17 0 28.5 11.5T360-880v400h40v-440q0-17 11.5-28.5T440-960q17 0 28.5 11.5T480-920v440h40v-400q0-17 11.5-28.5T560-920q17 0 28.5 11.5T600-880v400h40v-320q0-17 11.5-28.5T680-840q17 0 28.5 11.5T720-800v400q0 133-93.5 226.5T480-80Z",a.erase="M690-240h190v80H610l80-80Zm-500 80-85-85q-23-23-23.5-57t22.5-58l440-456q23-24 56.5-24t56.5 23l199 199q23 23 23 57t-23 57L520-160H190Zm296-80 314-322-198-198-442 456 64 64h262Zm-6-240Z",a.arrowUp="M440-160v-487L216-423l-56-57 320-320 320 320-56 57-224-224v487h-80Z",a.arrowDown="M440-800v487L216-537l-56 57 320 320 320-320-56-57-224 224v-487h-80Z",a.menu="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z",a.copy="M200-40q-33 0-56.5-23.5T120-120v-560q0-33 23.5-56.5T200-760h80v80h-80v560h440v-80h80v80q0 33-23.5 56.5T680-40H200Zm160-200q-33 0-56.5-23.5T280-320v-480q0-33 23.5-56.5T360-880h360q33 0 56.5 23.5T800-800v480q0 33-23.5 56.5T720-240H360Zm0-80h360v-480H360v480Zm0 0v-480 480Z",a.cut="M220-120C144-120 80-184 80-260S144-400 220-400 360-336 360-260 296-120 220-120Z M220-320C188-320 160-292 160-260S188-200 220-200 280-228 280-260 252-320 220-320Z M220-560C144-560 80-624 80-700S144-840 220-840 360-776 360-700 296-560 220-560Z M220-760C188-760 160-732 160-700S188-640 220-640 280-668 280-700 252-760 220-760Z M140-376L184-308 880-720 732-720Z M472-480L184-652 140-584 396-436Z M472-392L732-240 880-240 548-436Z",a.paste="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h167q11-35 43-57.5t70-22.5q40 0 71.5 22.5T594-840h166q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560h-80v120H280v-120h-80v560Zm280-560q17 0 28.5-11.5T520-800q0-17-11.5-28.5T480-840q-17 0-28.5 11.5T440-800q0 17 11.5 28.5T480-760Z",a.duplicate="M280-240q-33 0-56.5-23.5T200-320v-480q0-33 23.5-56.5T280-880h400q33 0 56.5 23.5T760-800v480q0 33-23.5 56.5T680-240H280Zm0-80h400v-480H280v480ZM120-80q-33 0-56.5-23.5T40-160v-560h80v560h520v80H120Zm160-720v480-480Z",a.selectAll="M80-40v-200h80v120h120v80H80Zm0-480v-200q0-33 23.5-56.5T160-800h120v80H160v120H80Zm200 480v-80h80v80h-80Zm0-720v-80h80v80h-80Zm160 720v-80h80v80h-80Zm0-720v-80h80v80h-80Zm160 720v-80h80v80h-80Zm0-720v-80h80v80h-80Zm160 720v-80h120v-120h80v200H760Zm120-480v-120H760v-80h120q33 0 56.5 23.5T960-800v200h-80Z",a.unlock="M240-80q-33 0-56.5-23.5T160-160v-400q0-33 23.5-56.5T240-640h280v-80q0-83 58.5-141.5T720-920q83 0 141.5 58.5T920-720h-80q0-50-35-85t-85-35q-50 0-85 35t-35 85v80h40q33 0 56.5 23.5T720-560v400q0 33-23.5 56.5T640-80H240Zm0-80h400v-400H240v400Zm200-120q33 0 56.5-23.5T520-360q0-33-23.5-56.5T440-440q-33 0-56.5 23.5T360-360q0 33 23.5 56.5T440-280Zm-200 120v-400 400Z";class r{constructor(){this.listeners=[],this.forward=t=>{this.listeners.length>0&&this.listeners.forEach((e=>e(t)))}}subscribe(t){this.listeners.push(t)}unsubscribe(t){const e=this.listeners.indexOf(t);if(!(e>=0))throw new Error("Unknown listener");this.listeners.splice(e,1)}count(){return this.listeners.length}}function c(t,e,s){const i=new r,o=n.element("span",{class:`mce-icon-button mce-icon-button-${s}`,title:e}),c=a.createSvg(t,"mce-icon-button-icon"),h=c.querySelector("path");return o.appendChild(c),o.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),i.forward()}),!1),{view:o,onClicked:i,setIcon(t){h.setAttribute("d",t)}}}class h{static create(t,e,s,i){var o;const r=document.createElement("div");r.className="mce-layers-panel-item";const d=c(l(e),"Toggle visibility","sm"),u=c(a.close,"Delete layer","sm"),v=c(a.menu||a.arrowUp,"Drag to reorder","sm");v.view.classList.add("mce-layer-drag-handle");const p=n.div({class:"mce-layers-panel-item-label"}),g=n.element("input",{class:"mce-layers-panel-item-label-input"});g.readOnly=!0,g.value=null!==(o=e.get("label"))&&void 0!==o?o:e.type,p.appendChild(g),r.appendChild(v.view),r.appendChild(d.view),r.appendChild(p),r.appendChild(u.view);const m=new h(r,t,e,g,d,v);return r.__layerItemObject=e,r.addEventListener("click",m.onItemClicked,!1),g.addEventListener("input",m.onLabelChanged,!1),d.onClicked.subscribe(m.onVisibilityClicked),u.onClicked.subscribe(m.onDeleteClicked),m.initDrag(),m}constructor(t,e,s,i,n,o){this.view=t,this.state=e,this.object=s,this.labelInput=i,this.visibilityButton=n,this.dragHandle=o,this.isSelected=!1,this.startY=0,this.dragStarted=!1,this.origIndex=-1,this.dragging=!1,this.rafPending=!1,this.currentDy=0,this.onPointerDown=t=>{t.preventDefault(),t.stopPropagation(),this.pointerId=t.pointerId,this.dragHandle.view.setPointerCapture(t.pointerId),this.listEl=this.view.parentElement,this.startY=t.clientY,this.origIndex=Array.from(this.listEl.children).indexOf(this.view),this.dragging=!0,this.dragStarted=!1,this.currentDy=0,this.view.style.willChange="transform",this.view.classList.add("mce-dragging"),this.listEl.classList.add("mce-layers-dragging"),document.addEventListener("pointermove",this.onPointerMove,!0),document.addEventListener("pointerup",this.onPointerUp,!0)},this.onPointerMove=t=>{if(!this.dragging)return;if(this.currentDy=t.clientY-this.startY,!this.dragStarted&&Math.abs(this.currentDy)>h.DRAG_THRESHOLD&&(this.dragStarted=!0),this.rafPending||(this.rafPending=!0,requestAnimationFrame((()=>{this.rafPending=!1,this.view.style.transform=`translateY(${this.currentDy}px)`}))),!this.dragStarted)return;const e=this.listEl,s=Array.from(e.children),i=s.indexOf(this.view),n=s[i-1],o=s[i+1];if(this.currentDy<0&&n){const s=n.getBoundingClientRect();this.view.getBoundingClientRect().top<s.top+s.height/2&&(e.insertBefore(this.view,n),this.startY=t.clientY,this.currentDy=0,this.view.style.transform="translateY(0)")}else if(this.currentDy>0&&o){const s=o.getBoundingClientRect();this.view.getBoundingClientRect().bottom>s.top+s.height/2&&(e.insertBefore(o,this.view),this.startY=t.clientY,this.currentDy=0,this.view.style.transform="translateY(0)")}},this.onPointerUp=t=>{var e;if(!this.dragging)return;if(this.dragging=!1,void 0!==this.pointerId)try{this.dragHandle.view.releasePointerCapture(this.pointerId)}catch(t){}if(document.removeEventListener("pointermove",this.onPointerMove,!0),document.removeEventListener("pointerup",this.onPointerUp,!0),this.view.classList.remove("mce-dragging"),this.view.style.transform="",this.view.style.willChange="",null===(e=this.listEl)||void 0===e||e.classList.remove("mce-layers-dragging"),!this.dragStarted)return;const s=this.view.parentElement,i=Array.from(s.children),n=this.state.canvas,o=n.getWorkspaceObjects(),a=i.map((t=>t.__layerItemObject)).filter(Boolean),r=o.filter((t=>!a.includes(t)));r.length>0&&(console.warn("Layer reordering: Found objects missing from DOM mapping, preserving them:",r),a.push(...r));o.forEach((t=>n.remove(t)));const c=a.reverse();for(const t of c)n.add(t);this.state.onLayerOrderChanged.forward()},this.onItemClicked=t=>{t.preventDefault(),t.stopPropagation(),this.state.selectObject(this.object)},this.onVisibilityClicked=()=>{this.object.selectable&&this.object.visible?(this.object.visible=!0,this.object.selectable=!1,this.state.canvas.getActiveObject()===this.object&&this.state.canvas.discardActiveObject()):this.object.visible&&!this.object.selectable?(this.object.visible=!1,this.object.selectable=!0):(this.object.visible=!0,this.object.selectable=!0),this.visibilityButton.setIcon(l(this.object)),this.state.canvas.requestRenderAll(),this.state.onPropertiesChanged.forward(this.object)},this.onMoveUpClicked=()=>{this.state.canvas.bringObjectForward(this.object),this.state.onLayerOrderChanged.forward()},this.onMoveDownClicked=()=>{this.state.canvas.sendObjectBackwards(this.object),this.state.onLayerOrderChanged.forward()},this.onDeleteClicked=()=>{this.state.canvas.remove(this.object)},this.onLabelChanged=()=>{this.object.set("label",this.labelInput.value),this.state.onPropertiesChanged.forward(this.object)}}initDrag(){this.dragHandle.view.addEventListener("pointerdown",this.onPointerDown,!1)}setIsSelected(t){this.isSelected=t,this.labelInput.readOnly=!t,this.view.classList.toggle("mce-selected",t)}updateIcon(){this.visibilityButton.setIcon(l(this.object))}}function l(t){if(!t.selectable){if(!t.visible)throw new Error("Unsupported state");return a.locked}return t.visible?a.eye:a.eyeOff}function d(t,e){const s=n.div({class:"mce-panel"}),i=n.div({class:"mce-panel-tabs"}),o=n.div({class:"mce-panel-tab"});o.innerText=t,i.appendChild(o);const a=n.div({class:"mce-panel-body"});return a.className="mce-panel-body",a.appendChild(e),s.appendChild(i),s.appendChild(a),{view:s}}h.DRAG_THRESHOLD=4;class u{static create(t){const e=document.createElement("div");e.className="mce-layers-list";const s=d("Layers",e),i=new u(s.view,t,e);return t.canvas.on("object:added",i.reloadList),t.canvas.on("object:removed",i.reloadList),t.canvas.on("selection:cleared",i.reloadSelection),t.canvas.on("selection:created",i.reloadSelection),t.canvas.on("selection:updated",i.reloadSelection),t.onLayerOrderChanged.subscribe(i.reloadList),t.onPropertiesChanged.subscribe(i.onPropertiesChanged),i.reloadList(),i}constructor(t,e,s){this.view=t,this.state=e,this.list=s,this.layers=[],this.reloadList=()=>{for(;this.list.firstChild;)this.list.removeChild(this.list.firstChild);this.layers.length=0,this.state.forEachObject(((t,e,s)=>{const i=0===e,n=h.create(this.state,t,i,s);this.layers.push(n),this.list.firstChild?this.list.insertBefore(n.view,this.list.firstChild):this.list.appendChild(n.view)})),this.reloadSelection()},this.reloadSelection=()=>{const t=this.state.canvas.getActiveObjects();for(const e of this.layers)e.setIsSelected(t.includes(e.object))},this.onPropertiesChanged=t=>{const e=this.layers.find((e=>e.object===t));e&&e.updateIcon()}}}class v{static create(t,e,s){const i=new v(t,s,e);for(const t of e)s.on(t,i.onExternalChanged);return i}constructor(t,e,s){this.state=t,this.object=e,this.events=s,this.accessors=[],this.onChanged=new r,this.onExternalChanged=()=>{for(const t of this.accessors){const e=t.getValue();e!==t.lastValue&&t.onExternalChanged.forward(e)}}}bind(t,e){const s={onExternalChanged:new r,lastValue:t(this.object),getValue:()=>t(this.object),setValue:t=>{e(this.object,t),s.lastValue=t,this.state.canvas.requestRenderAll(),this.onChanged.forward()}};return this.accessors.push(s),s}destroy(){for(const t of this.events)this.object.off(t,this.onExternalChanged)}}function p(t,e){const s=n.div({class:"mce-prop-simple"}),i=n.div({class:"mce-prop-simple-label"});i.innerText=t;const o=n.div({class:"mce-prop-simple-body"});return s.appendChild(i),s.appendChild(o),o.appendChild(e),{view:s}}function g(t,e,s){var i;const o=null!==(i=null==s?void 0:s.decimals)&&void 0!==i?i:1,a=n.element("input",{class:"mce-prop-number-input",type:"number",value:e.getValue().toFixed(o)});return s&&(s.step&&(a.step=s.step.toString()),"number"==typeof s.min&&a.setAttribute("min",String(s.min)),"number"==typeof s.max&&a.setAttribute("max",String(s.max))),a.addEventListener("input",(function(){const t=Number(a.value);e.setValue(t)}),!1),e.onExternalChanged.subscribe((function(t){a.value=t.toFixed(o)})),{view:p(t,a).view,destroy:function(){}}}function m(t){const e=n.div({class:"mce-prop-row"});for(const s of t){const t=n.div({class:"mce-prop-col"});t.appendChild(s.view),e.appendChild(t)}return{view:e,destroy:function(){t.forEach((t=>t.destroy()))}}}function b(t){const e=n.div({class:"mce-prop-rows"});for(const s of t)e.appendChild(s.view);return{view:e,destroy:function(){t.forEach((t=>t.destroy()))}}}function f(t,e){const s=[...e,m([g("X",t.bind((t=>t.left),((t,e)=>t.set("left",e)))),g("Y",t.bind((t=>t.top),((t,e)=>t.set("top",e))))]),m([g("Angle",t.bind((t=>t.angle),((t,e)=>t.set("angle",e))))]),m([g("Opacity",t.bind((t=>Math.round(100*t.opacity)),((t,e)=>t.set("opacity",Math.min(100,Math.max(e,0))/100))),{step:2,decimals:0,min:0,max:100})])];return{view:b(s).view,destroy:function(){s.forEach((t=>t.destroy()))}}}function w(t,e,s,i){const o=s.getValue(),a=n.element("select",{class:"mce-prop-choice"});a.addEventListener("change",(function(){const t=r[a.selectedIndex];s.setValue(t)}),!1);const r=Object.values(e),c=Object.keys(e).map((t=>{const s=n.element("option",{value:t});return s.text=t,e[t]===o&&(s.selected=!0),(null==i?void 0:i.showFontPreview)&&"string"==typeof e[t]&&(s.style.fontFamily=`"${e[t]}", sans-serif`),a.appendChild(s),s}));return(null==i?void 0:i.showFontPreview)&&"string"==typeof o&&(a.style.fontFamily=`"${o}", sans-serif`,a.addEventListener("change",(()=>{const t=r[a.selectedIndex];"string"==typeof t&&(a.style.fontFamily=`"${t}", sans-serif`)}),!1)),s.onExternalChanged.subscribe((function(t){const e=r.indexOf(t);if(e>=0)for(let t=0;t<c.length;t++)c[t].selected=t===e})),{view:p(t,a).view,destroy:function(){}}}function y(t,e){const s=n.element("input",{class:"mce-prop-color-input",type:"color",value:e.getValue()||"#000"});return s.addEventListener("input",(function(){e.setValue(s.value)}),!1),e.onExternalChanged.subscribe((function(t){s.value=t})),{view:p(t,s).view,destroy:function(){}}}const C=["-apple-system","BlinkMacSystemFont","Segoe UI","Segoe UI Variable","Segoe UI Historic","Segoe UI Black","Segoe UI Light","Segoe UI Semibold","system-ui","Inter","Open Sans","Lato","Montserrat","Nunito","Poppins","Source Sans Pro","Raleway","PT Sans","Oswald","Roboto","Roboto Condensed","Roboto Slab","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue","Noto Sans","Calibri","Cambria","Candara","Consolas","Constantia","Corbel","Courier New","Ebrima","Franklin Gothic Medium","Gabriola","Gadugi","Georgia","Impact","Javanese Text","Leelawadee UI","Lucida Console","Lucida Sans Unicode","Malgun Gothic","Microsoft Himalaya","Microsoft JhengHei","Microsoft New Tai Lue","Microsoft PhagsPa","Microsoft Sans Serif","Microsoft Tai Le","Microsoft YaHei","Microsoft Yi Baiti","MingLiU-ExtB","Mongolian Baiti","MS Gothic","MV Boli","Myanmar Text","Nirmala UI","Palatino Linotype","Segoe MDL2 Assets","Segoe Print","Segoe Script","SimSun","Sitka","Sylfaen","Symbol","Tahoma","Times New Roman","Trebuchet MS","Verdana","Webdings","Wingdings","Yu Gothic","SF Pro Display","SF Pro Text","SF Pro Rounded","SF Mono","SF Compact Display","SF Compact Text","New York","Helvetica","Helvetica Neue","Arial","Arial Black","Arial Narrow","Arial Rounded MT Bold","Avenir","Avenir Next","Avenir Next Condensed","Baskerville","Big Caslon","Bodoni 72","Bodoni 72 Oldstyle","Bodoni 72 Smallcaps","Bradley Hand","Brush Script MT","Chalkboard","Chalkboard SE","Chalkduster","Charter","Cochin","Comic Sans MS","Copperplate","Courier","Didot","Futura","Geneva","Gill Sans","Hoefler Text","Lucida Grande","Marker Felt","Menlo","Monaco","Optima","Palatino","Papyrus","Phosphate","Rockwell","Savoye LET","SignPainter","Skia","Snell Roundhand","Tahoma","Times","Trattatello","Zapfino","DejaVu Sans","DejaVu Sans Mono","DejaVu Serif","Liberation Sans","Liberation Sans Narrow","Liberation Serif","Liberation Mono","Linux Libertine","Linux Biolinum","Droid Sans","Droid Sans Mono","Droid Serif","Ubuntu","Ubuntu Condensed","Ubuntu Light","Ubuntu Mono","Cantarell","Source Sans Pro","Source Serif Pro","Source Code Pro","Noto Sans","Noto Serif","Noto Mono","Adobe Clean","Adobe Garamond Pro","Adobe Caslon Pro","Adobe Jenson Pro","Minion Pro","Myriad Pro","Trajan Pro","Roboto","Open Sans","Lato","Oswald","Source Sans Pro","Montserrat","Raleway","PT Sans","Lora","Arimo","Tinos","Cousine","Crimson Text","Droid Sans","Droid Serif","Droid Sans Mono","PT Serif","PT Mono","Inconsolata","Merriweather","Playfair Display","Aptos","Calibri","Cambria","Candara","Consolas","Constantia","Corbel","Franklin Gothic Medium","Gabriola","Impact","Lucida Console","Palatino Linotype","Segoe Print","Segoe Script","Tahoma","Times New Roman","Trebuchet MS","Verdana","Fira Code","JetBrains Mono","Cascadia Code","Cascadia Mono","Victor Mono","Operator Mono","Dank Mono","Hack","Iosevka","Input","Source Code Pro","SF Mono","Menlo","Monaco","Consolas","Courier New","Ubuntu Mono","DejaVu Sans Mono","Liberation Mono","Noto Sans Mono","sans-serif","serif","monospace","cursive","fantasy"],x=["Arial","Times New Roman","Courier New","sans-serif","serif","monospace"];let j=null,S=null;function M(){return i(this,void 0,void 0,(function*(){return null!==j?j:(null!==S||(S=new Promise((t=>{const e=()=>{const e=new Set;if(x.forEach((t=>e.add(t))),C.forEach((t=>{(function(t){if(["sans-serif","serif","monospace","cursive","fantasy"].includes(t.toLowerCase()))return!0;try{const e=document.createElement("canvas"),s=e.getContext("2d");if(!s)return!1;e.width=200,e.height=100;const i="mmmmmmmmmmlli",n="72px",o="monospace";s.textBaseline="top",s.textAlign="left",s.font=`${n} ${o}`;const a=s.measureText(i).width;s.font=`${n} "${t}", ${o}`;const r=s.measureText(i).width;return Math.abs(r-a)>1}catch(t){return!1}})(t)&&e.add(t)})),"fonts"in document&&document.fonts&&"function"==typeof document.fonts.check)try{["SF Pro Display","SF Pro Text","San Francisco","Segoe UI Variable","Segoe UI Historic","Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji","System","-apple-system","BlinkMacSystemFont"].forEach((t=>{try{document.fonts.check(`12px "${t}"`)&&e.add(t)}catch(t){}}))}catch(t){}j=Array.from(e).sort(((t,e)=>{const s=["-apple-system","BlinkMacSystemFont","Segoe UI","system-ui"],i=["sans-serif","serif","monospace","cursive","fantasy"],n=["Inter","Open Sans","Roboto","Lato","Montserrat","Arial","Helvetica","Times New Roman","Georgia"],o=s.includes(t),a=s.includes(e);if(o&&!a)return-1;if(!o&&a)return 1;const r=n.includes(t),c=n.includes(e);if(r&&!c)return-1;if(!r&&c)return 1;const h=i.includes(t),l=i.includes(e);return!h&&l?-1:h&&!l?1:t.localeCompare(e)})),t(j)};"requestIdleCallback"in window?requestIdleCallback(e,{timeout:1e3}):setTimeout(e,0)}))),S)}))}function k(){const t=null!==j?j:(M().catch(console.error),["-apple-system","BlinkMacSystemFont","Segoe UI","Roboto","Arial","Helvetica","Times New Roman","Georgia","Courier New","sans-serif","serif","monospace"]),e={};return t.forEach((t=>{e[t]=t})),e}class O{static create(t,s){switch(t){case"rect":return function(t){const e=m([g("W",t.bind((t=>t.getScaledWidth()),((t,e)=>{t.set("width",e),t.set("scaleX",1)}))),g("H",t.bind((t=>t.getScaledHeight()),((t,e)=>{t.set("height",e),t.set("scaleY",1)})))]),s=m([g("Radius",t.bind((t=>t.rx),((t,e)=>{t.set("rx",e),t.set("ry",e)})))]),i=m([y("Fill",t.bind((t=>t.fill),((t,e)=>t.set("fill",e))))]),n=m([g("SW",t.bind((t=>t.strokeWidth),((t,e)=>t.set("strokeWidth",e)))),y("SC",t.bind((t=>t.stroke),((t,e)=>t.set("stroke",e))))]);return f(t,[e,s,i,n])}(s);case"circle":return function(t){const e=m([g("Radius",t.bind((t=>t.radius),((t,e)=>t.set("radius",e))))]),s=m([y("Fill",t.bind((t=>t.fill),((t,e)=>t.set("fill",e))))]),i=m([g("SW",t.bind((t=>t.strokeWidth),((t,e)=>t.set("strokeWidth",e)))),y("SC",t.bind((t=>t.stroke),((t,e)=>t.set("stroke",e))))]);return f(t,[e,s,i])}(s);case"textbox":return function(t){const s=m([g("Font size",t.bind((t=>t.fontSize),((t,e)=>t.set("fontSize",e))))]),i=m([g("Line height",t.bind((t=>t.lineHeight),((t,e)=>t.set("lineHeight",e))),{step:.05,decimals:2})]),n=m([y("Color",t.bind((t=>t.fill),((t,e)=>t.set("fill",e))))]),o=m([w("Text align",{Left:"left",Center:"center",Right:"right",Justify:"justify"},t.bind((t=>t.textAlign),((t,e)=>t.set("textAlign",e))))]),a=m([w("Vertical align",{Top:e.MceVerticalAlign.top,Middle:e.MceVerticalAlign.middle,Bottom:e.MceVerticalAlign.bottom},t.bind((t=>t.verticalAlign),((t,e)=>t.set("verticalAlign",e))))]),r=m([w("Font",k(),t.bind((t=>t.fontFamily),((t,e)=>t.set("fontFamily",e))),{showFontPreview:!0})]),c=m([w("Weight",{Bold:"bold",Normal:"normal"},t.bind((t=>t.fontWeight),((t,e)=>t.set("fontWeight",e))))]),h=m([w("Bg",{Off:e.MceTextBackground.none,Behind:e.MceTextBackground.behind},t.bind((t=>t.textBackground),((t,e)=>t.set("textBackground",e)))),y("Color",t.bind((t=>t.textBackgroundFill),((t,e)=>t.set("textBackgroundFill",e))))]),l=m([g("SW",t.bind((t=>t.strokeWidth),((t,e)=>t.set("strokeWidth",e))),{min:0}),y("SC",t.bind((t=>t.stroke),((t,e)=>t.set("stroke",e))))]);return f(t,[s,i,n,o,a,r,c,h,l])}(s);case"image":return function(t){const e=m([g("W",t.bind((t=>t.getScaledWidth()),((t,e)=>{const s=e/t.getOriginalSize().width;t.set("scaleX",s)}))),g("H",t.bind((t=>t.getScaledHeight()),((t,e)=>{const s=e/t.getOriginalSize().height;t.set("scaleY",s)})))]);return f(t,[e])}(s);default:return function(t){return f(t,[])}(s)}}}class T{static create(t,e){const s=n.div({class:"mce-properties-editor"}),i=v.create(t,["modified","scaling"],e);i.onChanged.subscribe((()=>t.onPropertiesChanged.forward(e)));const o=O.create(e.type,i);return s.appendChild(o.view),new T(s,i,o)}constructor(t,e,s){this.view=t,this.manager=e,this.editor=s}destroy(){this.manager.destroy(),this.editor.destroy()}}class E{static create(t){const e=v.create(t,[],t.canvas);e.onChanged.subscribe((()=>t.onPropertiesChanged.forward(t.canvas)));const s=n.div({class:"mce-properties-editor"}),i=b([m([g("Width",e.bind((t=>t.workspaceWidth),((t,e)=>{t.workspaceBackground.set("width",e),t.workspaceWidth=e})),{decimals:0})]),m([g("Height",e.bind((t=>t.workspaceHeight),((t,e)=>{t.workspaceBackground.set("height",e),t.workspaceHeight=e})),{decimals:0})])]);return s.appendChild(i.view),new E(s)}constructor(t){this.view=t}destroy(){}}class q{static create(t){const e=document.createElement("div"),s=d("Properties",e),i=new q(s.view,t,e);return t.canvas.on("selection:cleared",i.onSelectionUpdated),t.canvas.on("selection:updated",i.onSelectionUpdated),t.canvas.on("selection:created",i.onSelectionUpdated),i.refresh(),i}constructor(t,e,s){this.view=t,this.state=e,this.container=s,this.onSelectionUpdated=()=>{this.refresh()}}refresh(){const t=this.state.canvas.getActiveObjects();if(this.component&&this.container.removeChild(this.component.view),1===t.length){const e=t[0];this.component=T.create(this.state,e)}else this.component=E.create(this.state);this.container.appendChild(this.component.view)}}class L{static create(t,e){const s=n.div({class:"mce-sidebar"}),i=n.div({class:"mce-sidebar-switch"});i.appendChild(a.createSvg(a.menu,"mce-sidebar-switch-icon"));const o=n.div({class:"mce-sidebar-body"});if(!1!==e.properties){const e=q.create(t);o.appendChild(e.view)}if(!1!==e.layers){const e=u.create(t);o.appendChild(e.view)}s.appendChild(i),s.appendChild(o);const r=new L(s);return i.addEventListener("click",r.onSwitchClicked,!1),r}constructor(t){this.view=t,this.onSwitchClicked=()=>{this.view.classList.toggle("mce-visible")}}}class A{constructor(t,e,s,i){this.canvas=t,this.mode=e,this.configuration=s,this.container=i,this.onModeChanged=new r,this.onZoomChanged=new r,this.onLayerOrderChanged=new r,this.onPropertiesChanged=new r,this.onBrushConfigurationChanged=new r,this.onHistoryChanged=new r,this.brush=Object.assign({brushSize:10,brushColor:"#ff0000"},this.configuration.brush||{}),this.rect=Object.assign({fillColor:"#ff0000"},this.configuration.rect||{}),this.circle=Object.assign({fillColor:"#ff0000"},this.configuration.circle||{}),this.history={stack:[],index:-1,push:t=>{var e,s;const i=this.history.stack[this.history.index];try{if(i&&JSON.stringify(null!==(e=i.data)&&void 0!==e?e:i)===JSON.stringify(null!==(s=t.data)&&void 0!==s?s:t))return}catch(t){}this.history.stack=this.history.stack.slice(0,this.history.index+1),this.history.stack.push(t),this.history.index=this.history.stack.length-1,this.onHistoryChanged.forward()},canUndo:()=>this.history.index>0,canRedo:()=>this.history.index<this.history.stack.length-1,undo:()=>this.history.canUndo()?(this.history.index--,this.history.stack[this.history.index]):null,redo:()=>this.history.canRedo()?(this.history.index++,this.history.stack[this.history.index]):null},this.isApplying=!1,this.historyPaused=!1,this.pendingSnapshot=!1}canUndo(){return this.history.canUndo()}canRedo(){return this.history.canRedo()}scheduleSnapshot(){this.pendingSnapshot||(this.pendingSnapshot=!0,requestAnimationFrame((()=>{this.pendingSnapshot=!1,this.takeSnapshot()})))}initHistory(){this.takeSnapshot();const t=()=>this.scheduleSnapshot();this.canvas.on("object:added",t),this.canvas.on("object:removed",t),this.canvas.on("object:modified",t)}takeSnapshot(){if(!this.isApplying&&!this.historyPaused)try{const t=this.canvas.toImageJSON();this.history.push(t)}catch(t){}}undo(){const t=this.history.undo();t&&this.applySnapshot(t)}redo(){const t=this.history.redo();t&&this.applySnapshot(t)}pauseHistory(){this.historyPaused=!0}resumeHistory(){this.historyPaused=!1,this.scheduleSnapshot()}applySnapshot(t){try{this.isApplying=!0;const e=console.warn;console.warn=(...t)=>{t.join(" ").includes("Setting type has no effect")||e.apply(console,t)},this.canvas.loadFromJSON(t.data).then((()=>{console.warn=e,this.isApplying=!1,this.canvas.renderAll()})).catch((()=>{console.warn=e,this.isApplying=!1}))}catch(t){this.isApplying=!1}}center(){const t=Math.min(1,this.container.clientWidth/this.canvas.workspaceWidth,this.container.clientHeight/this.canvas.workspaceHeight),s=this.canvas.workspaceWidth*t,i=this.canvas.workspaceHeight*t,n=this.container.clientWidth/2-s/2,o=this.container.clientHeight/2-i/2;this.canvas.setZoom(t),this.canvas.absolutePan(new e.Point(-n,-o)),this.onZoomChanged.forward()}add(t){var e,s;let i="function"==typeof t.get?t.get("label"):void 0;if(!i){i={image:"Image",textbox:"Textbox",rect:"Rect",circle:"Circle",path:"Path"}[(null===(s=null===(e=t.type)||void 0===e?void 0:e.toLowerCase)||void 0===s?void 0:s.call(e))||""]||"Layer"}const n=i.replace(/ \(\d+\)$/,""),o=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(`^${o} ?(?:\\((\\d+)\\))?$`);let r=0;this.canvas.getObjects().forEach((t=>{const e="function"==typeof t.get?t.get("label"):void 0;if(e){const t=e.match(a);if(t){const e=t[1]?parseInt(t[1],10):0;e>r&&(r=e)}}}));const c=`${n} (${r+1})`;"function"==typeof t.set&&t.set("label",c),this.canvas.add(t),this.canvas.requestRenderAll()}selectObject(t){this.canvas.discardActiveObject(),this.canvas.setActiveObject(t),this.canvas.renderAll()}forEachObject(t){const e=this.canvas.getWorkspaceObjects();for(let s=0;s<e.length;s++)t(e[s],s,s+1===e.length)}disableSelection(){this.canvas.selection=!1;const t=new Map;return this.forEachObject((e=>{t.set(e,e.selectable),e.selectable&&e.set("selectable",!1)})),new P(t)}setMode(t){this.mode=t,this.onModeChanged.forward(t)}}class P{constructor(t){this.map=t}revert(){this.map.forEach(((t,e)=>e.set("selectable",t)))}}class D{constructor(t){this.state=t}init(){this.state.canvas.setCursor("move"),this.state.canvas.selection=!0}destroy(){}}class B{static create(t,e){const s=t.disableSelection(),i=new B(t,s,e);return t.canvas.on("mouse:down",i.onDown),t.canvas.on("mouse:move",i.onMove),t.canvas.on("mouse:up",i.onUp),t.canvas.setCursor("crosshair"),i}constructor(t,e,s){this.state=t,this.selectionReverter=e,this.objectFactory=s,this.object=null,this.origX=0,this.origY=0,this.onFinished=new r,this.onDown=t=>{t.e.preventDefault(),t.e.stopPropagation(),this.state.canvas.discardActiveObject();const e=this.state.canvas.getPointer(t.e);this.origX=e.x,this.origY=e.y,this.object=this.objectFactory(),this.object.set("left",this.origX),this.object.set("top",this.origY),this.state.pauseHistory()},this.onMove=t=>{if(!this.object)return;const e=this.state.canvas.getPointer(t.e),s=e.x-this.origX,i=e.y-this.origY,n=Math.abs(s),o=Math.abs(i);this.object.set({left:s>0?this.origX:this.origX+s,top:i>0?this.origY:this.origY+i,width:Math.max(n,1),height:Math.max(o,1)}),this.state.canvas.contains(this.object)||this.state.add(this.object),this.state.canvas.renderAll()},this.onUp=()=>{this.object&&(this.state.canvas.contains(this.object)||(this.object.set({width:100,height:50}),this.state.add(this.object)),this.state.resumeHistory(),this.onFinished.forward(this.object),this.object=null)}}destroy(){this.state.canvas.off("mouse:down",this.onDown),this.state.canvas.off("mouse:move",this.onMove),this.state.canvas.off("mouse:up",this.onUp),this.selectionReverter.revert(),this.state.resumeHistory()}}class H{constructor(t){this.state=t}init(){this.painter=B.create(this.state,(()=>new e.MceRect({fill:this.state.rect.fillColor,stroke:this.state.rect.fillColor,strokeWidth:0}))),this.painter.onFinished.subscribe((e=>{this.state.canvas.setActiveObject(e),this.state.setMode(t.EditorMode.select)}))}destroy(){this.painter&&(this.painter.destroy(),this.painter=void 0)}}class Z{static create(t,e){const s=t.disableSelection(),i=new Z(t,s,e);return t.canvas.on("mouse:down",i.onDown),t.canvas.on("mouse:move",i.onMove),t.canvas.on("mouse:up",i.onUp),t.canvas.setCursor("crosshair"),i}constructor(t,e,s){this.state=t,this.selectionReverter=e,this.objectFactory=s,this.object=null,this.origX=0,this.origY=0,this.onFinished=new r,this.onDown=t=>{t.e.preventDefault(),t.e.stopPropagation(),this.state.canvas.discardActiveObject();const e=this.state.canvas.getPointer(t.e);this.origX=e.x,this.origY=e.y,this.object=this.objectFactory(),this.object.set({left:this.origX,top:this.origY,radius:5,originX:"center",originY:"center"}),this.state.pauseHistory()},this.onMove=t=>{if(!this.object)return;const e=this.state.canvas.getPointer(t.e),s=e.x-this.origX,i=e.y-this.origY,n=Math.sqrt(s*s+i*i);this.object.set({left:this.origX,top:this.origY,radius:Math.max(n,5),originX:"center",originY:"center"}),this.state.canvas.contains(this.object)||this.state.add(this.object),this.state.canvas.renderAll()},this.onUp=()=>{if(this.object){if(this.state.canvas.contains(this.object)){(this.object.radius||5)<10&&this.object.set({radius:10})}else this.object.set({radius:25}),this.state.add(this.object);this.state.resumeHistory(),this.onFinished.forward(this.object),this.object=null}}}destroy(){this.state.canvas.off("mouse:down",this.onDown),this.state.canvas.off("mouse:move",this.onMove),this.state.canvas.off("mouse:up",this.onUp),this.selectionReverter.revert(),this.state.resumeHistory()}}class F extends e.Circle{constructor(t){const e=function(t,e){var s={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(s[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(t,i[n])&&(s[i[n]]=t[i[n]])}return s}(t||{},["type"]);super(Object.assign({fill:"#000000",strokeWidth:0,stroke:"#000000",label:"Circle"},e)),this.label="Circle"}}class I{constructor(t){this.state=t}init(){this.painter=Z.create(this.state,(()=>new F({fill:this.state.circle.fillColor,stroke:this.state.circle.fillColor,strokeWidth:0,radius:25}))),this.painter.onFinished.subscribe((e=>{this.state.canvas.setActiveObject(e),this.state.setMode(t.EditorMode.select)}))}destroy(){this.painter&&(this.painter.destroy(),this.painter=void 0)}}class R{constructor(t){this.state=t}init(){this.painter=B.create(this.state,(()=>new e.Rect({fill:"transparent",stroke:"#26aa5a",strokeWidth:1}))),this.painter.onFinished.subscribe((s=>{const i=Math.max(s.getScaledHeight(),10),n=Math.min(i,50),o=new e.MceTextbox("Text",{left:s.left,top:s.top,width:s.getScaledWidth(),maxHeight:i,fontSize:n,fill:"#000000",fontFamily:"Arial, Helvetica, sans-serif"});this.state.canvas.remove(s),this.state.add(o),this.state.canvas.setActiveObject(o),this.state.setMode(t.EditorMode.select)}))}destroy(){this.painter&&(this.painter.destroy(),this.painter=void 0)}}class U{constructor(t){this.state=t,this.brush=new e.PencilBrush(this.state.canvas),this.reloadBrush=()=>{this.brush.width=this.state.brush.brushSize,this.brush.color=this.state.brush.brushColor}}init(){this.reloadBrush(),this.state.canvas.freeDrawingBrush=this.brush,this.state.canvas.isDrawingMode=!0,this.state.canvas.on("path:created",(t=>{const s=t.path;this.state.canvas.remove(s);const i=new e.McePath(s.path,s);this.state.canvas.add(i)})),this.state.onBrushConfigurationChanged.subscribe(this.reloadBrush)}destroy(){this.state.canvas.freeDrawingBrush=void 0,this.state.canvas.isDrawingMode=!1,this.state.onBrushConfigurationChanged.unsubscribe(this.reloadBrush)}}class W{constructor(t){this.state=t,this.isPanning=!1,this.onMouseDown=t=>{t.e.preventDefault(),t.e.stopPropagation(),this.isPanning=!0,this.lastPos={x:t.e.clientX,y:t.e.clientY},this.state.canvas.setCursor("grabbing")},this.onMouseMove=t=>{if(!this.isPanning||!this.lastPos)return;const e=t.e,s=e.clientX-this.lastPos.x,i=e.clientY-this.lastPos.y,n=this.state.canvas.viewportTransform;n&&(n[4]+=s,n[5]+=i,this.state.canvas.requestRenderAll()),this.lastPos={x:e.clientX,y:e.clientY},this.state.canvas.setCursor("grabbing")},this.onMouseUp=()=>{this.isPanning=!1,this.lastPos=void 0,this.state.canvas.setCursor("grab")}}init(){this.selectionReverter=this.state.disableSelection(),this.state.canvas.selection=!1,this.prevDefaultCursor=this.state.canvas.defaultCursor,this.prevHoverCursor=this.state.canvas.hoverCursor,this.state.canvas.defaultCursor="grab",this.state.canvas.hoverCursor="grab",this.state.canvas.setCursor("grab"),this.state.canvas.on("mouse:down",this.onMouseDown),this.state.canvas.on("mouse:move",this.onMouseMove),this.state.canvas.on("mouse:up",this.onMouseUp)}destroy(){var t;this.state.canvas.off("mouse:down",this.onMouseDown),this.state.canvas.off("mouse:move",this.onMouseMove),this.state.canvas.off("mouse:up",this.onMouseUp),null===(t=this.selectionReverter)||void 0===t||t.revert(),void 0!==this.prevDefaultCursor&&(this.state.canvas.defaultCursor=this.prevDefaultCursor),void 0!==this.prevHoverCursor&&(this.state.canvas.hoverCursor=this.prevHoverCursor),this.state.canvas.setCursor("default")}}class N{static get(e,s){switch(e){case t.EditorMode.select:return new D(s);case t.EditorMode.hand:return new W(s);case t.EditorMode.rect:return new H(s);case t.EditorMode.circle:return new I(s);case t.EditorMode.brush:return new U(s);case t.EditorMode.textbox:return new R(s);default:return new D(s)}}}class Y{static attach(t,e){const s=new Y(t,e);return e.addEventListener("contextmenu",s.onContextMenu),document.addEventListener("click",s.hide),document.addEventListener("keydown",s.onKeyDown),s}constructor(t,e){this.state=t,this.isVisible=!1,this.currentObjects=[],this.clipboard=[],this.mouseX=0,this.mouseY=0,this.onContextMenu=t=>{t.preventDefault(),t.stopPropagation(),this.mouseX=t.clientX,this.mouseY=t.clientY;const e=this.getObjectsAtPosition(t),s=this.state.canvas.getActiveObjects();if(s.length>0)this.currentObjects=this.filterBackgroundFromSelection(s);else if(e.length>0){const s=e.filter((t=>t!==this.state.canvas.backgroundImage&&t!==this.state.canvas.workspaceBackground));if(s.length>0){const e=this.selectBestObject(s,t);this.currentObjects=[e],this.state.selectObject(e)}else this.currentObjects=[]}else this.currentObjects=[];this.show(t.clientX,t.clientY)},this.hide=()=>{this.isVisible&&(this.menu.style.display="none",this.isVisible=!1)},this.onKeyDown=t=>{"Escape"===t.key&&this.hide()},this.host=e,this.menu=this.createMenuElement(),document.body.appendChild(this.menu)}createMenuElement(){return n.div({class:"mce-context-menu",style:"\n\t\t\t\tposition: fixed;\n\t\t\t\tbackground: #474747;\n\t\t\t\tborder: 1px solid #2b2b2b;\n\t\t\t\tborder-radius: 4px;\n\t\t\t\tpadding: 4px 0;\n\t\t\t\tmin-width: 180px;\n\t\t\t\tbox-shadow: 0 6px 14px rgba(0,0,0,0.3);\n\t\t\t\tz-index: 10000;\n\t\t\t\tdisplay: none;\n\t\t\t\tcolor: #fff;\n\t\t\t\tfont-size: 13px;\n\t\t\t\tfont-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;\n\t\t\t"})}filterBackgroundFromSelection(t){return t.filter((t=>t!==this.state.canvas.backgroundImage&&t!==this.state.canvas.workspaceBackground))}getObjectsAtPosition(t){const e=this.state.canvas.getPointer(t),s=this.state.canvas.getObjects(),i=[];for(let t=s.length-1;t>=0;t--){const n=s[t];n!==this.state.canvas.backgroundImage&&n!==this.state.canvas.workspaceBackground&&n.selectable&&n.visible&&(this.isPointInObject(n,e)&&i.push(n))}return i}isPointInObject(t,e){if("function"==typeof t.containsPoint)return t.containsPoint(e);const s=t.getBoundingRect();return e.x>=s.left&&e.x<=s.left+s.width&&e.y>=s.top&&e.y<=s.top+s.height}selectBestObject(t,e){if(1===t.length)return t[0];const s=this.state.canvas.getActiveObject();if(s&&t.includes(s)){const e=t.indexOf(s);return t[(e+1)%t.length]}return t[0]}buildEmptyCanvasItems(){return[{text:"Paste",icon:a.paste,action:()=>this.paste(),enabled:this.clipboard.length>0},{separator:!0,text:"",action:()=>{}},{text:"Select All",icon:a.selectAll,action:()=>this.selectAll()}]}buildObjectItems(){const t=this.currentObjects.length>1,e=this.currentObjects[0],s=[{text:"Copy",icon:a.copy,action:()=>this.copy()},{text:"Cut",icon:a.cut,action:()=>this.cut()},{text:"Paste",icon:a.paste,action:()=>this.paste(),enabled:this.clipboard.length>0},{text:"Duplicate",icon:a.duplicate,action:()=>this.duplicate()},{separator:!0,text:"",action:()=>{}},{text:"Delete",icon:a.close,action:()=>this.delete()}];return t||s.push({separator:!0,text:"",action:()=>{}},{text:"Bring to Front",icon:a.arrowUp,action:()=>this.bringToFront()},{text:"Bring Forward",icon:a.arrowUp,action:()=>this.bringForward()},{text:"Send Backward",icon:a.arrowDown,action:()=>this.sendBackward()},{text:"Send to Back",icon:a.arrowDown,action:()=>this.sendToBack()},{separator:!0,text:"",action:()=>{}},{text:(null==e?void 0:e.visible)?"Hide":"Show",icon:(null==e?void 0:e.visible)?a.eyeOff:a.eye,action:()=>this.toggleVisibility()},{text:(null==e?void 0:e.selectable)?"Lock":"Unlock",icon:(null==e?void 0:e.selectable)?a.locked:a.unlock,action:()=>this.toggleLock()}),s}show(t,e){const s=this.currentObjects.length>0?this.buildObjectItems():this.buildEmptyCanvasItems();this.menu.innerHTML="",s.forEach((t=>{if(t.separator){const t=n.div({style:"\n\t\t\t\t\t\theight: 1px;\n\t\t\t\t\t\tbackground: rgba(255,255,255,0.15);\n\t\t\t\t\t\tmargin: 6px 0;\n\t\t\t\t\t"});this.menu.appendChild(t)}else{const e=n.element("button",{class:"mce-context-menu-item",style:`\n\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\talign-items: center;\n\t\t\t\t\t\twidth: 100%;\n\t\t\t\t\t\tpadding: 8px 12px;\n\t\t\t\t\t\tbackground: transparent;\n\t\t\t\t\t\tcolor: ${!1===t.enabled?"#888":"#fff"};\n\t\t\t\t\t\tborder: 0;\n\t\t\t\t\t\ttext-align: left;\n\t\t\t\t\t\tcursor: ${!1===t.enabled?"default":"pointer"};\n\t\t\t\t\t\tfont-size: inherit;\n\t\t\t\t\t\tfont-family: inherit;\n\t\t\t\t\t`});if(t.icon){const s=a.createSvg(t.icon,"mce-context-menu-icon");s.style.cssText="\n\t\t\t\t\t\twidth: 16px;\n\t\t\t\t\t\theight: 16px;\n\t\t\t\t\t\tmargin-right: 8px;\n\t\t\t\t\t\tfill: currentColor;\n\t\t\t\t\t",e.appendChild(s)}const s=n.element("span",{style:"flex: 1;"});s.textContent=t.text,e.appendChild(s),!1!==t.enabled&&(e.addEventListener("click",(e=>{e.stopPropagation(),t.action(),this.hide()})),e.addEventListener("mouseenter",(()=>{e.style.background="#5d5d5d"})),e.addEventListener("mouseleave",(()=>{e.style.background="transparent"}))),this.menu.appendChild(e)}})),this.menu.style.left=`${t}px`,this.menu.style.top=`${e}px`,this.menu.style.display="block";const i=this.menu.getBoundingClientRect();i.right>window.innerWidth&&(this.menu.style.left=t-i.width+"px"),i.bottom>window.innerHeight&&(this.menu.style.top=e-i.height+"px"),this.isVisible=!0}copy(){0!==this.currentObjects.length&&(console.log("Copying objects:",this.currentObjects.length),this.clipboard=this.currentObjects.map((t=>t.toObject())),console.log("Clipboard contents:",this.clipboard))}cut(){console.log("Cutting objects"),this.copy(),this.delete()}createObjectFromData(t){var e,s;try{const i=window.miniCanvasCore;if(!i)return console.warn("miniCanvasCore not available"),null;const n=Object.assign({},t);delete n.canvas,delete n._objects,console.log("Object type:",t.type,"Available core classes:",Object.keys(i));const o=t.type.toLowerCase();if("rect"===o||"rectangle"===o)return new i.MceRect(n);if("circle"===o)return new i.MceCircle(n);if("textbox"===o||"text"===o)return new i.MceTextbox(t.text||"",n);if("path"===o)return new i.McePath(t.path,n);if("image"===o){if(t.src||(null===(e=t._element)||void 0===e?void 0:e.src)){const e=new Image;return e.onload=()=>{console.log("Image loaded for paste/duplicate")},e.src=t.src||(null===(s=t._element)||void 0===s?void 0:s.src),new i.MceImage(e,n)}return console.warn("Image object missing src"),null}const a=`Mce${t.type.charAt(0).toUpperCase()+t.type.slice(1).toLowerCase()}`;if(i[a])return console.log("Creating with exact type name:",a),"textbox"===o||"text"===o?new i[a](t.text||"",n):new i[a](n);const r=window.fabric;return r&&r[t.type]?(console.log("Creating with fabric type:",t.type),"textbox"===o||"text"===o?new r[t.type](t.text||"",n):new r[t.type](n)):r&&r[o]?(console.log("Creating with lowercase fabric type:",o),"textbox"===o||"text"===o?new r[o](t.text||"",n):new r[o](n)):(console.warn(`Unknown object type: ${t.type}, available types:`,Object.keys(i)),null)}catch(t){console.warn("Failed to create object from data:",t)}return null}paste(){if(0===this.clipboard.length)return;console.log("Pasting objects:",this.clipboard.length),this.state.canvas.discardActiveObject();const t=[];let e=0;this.clipboard.forEach((s=>{try{console.log("Creating object from data:",s);const i=this.createObjectFromData(s);if(i){console.log("Created object:",i);const s=this.state.canvas.getElement().getBoundingClientRect(),n=this.mouseX-s.left,o=this.mouseY-s.top,a=this.state.canvas.getZoom(),r=this.state.canvas.viewportTransform,c={x:(n-r[4])/a,y:(o-r[5])/a},h=10*e;i.set({left:c.x+h,top:c.y+h}),this.state.add(i),t.push(i)}else console.warn("Failed to create object")}catch(t){console.warn("Failed to paste object:",t)}e++,e===this.clipboard.length&&(this.state.onLayerOrderChanged.forward(),setTimeout((()=>{if(console.log("Selecting new objects:",t.length),1===t.length)this.state.selectObject(t[0]);else if(t.length>1){const e=new this.state.canvas.constructor.ActiveSelection(t,{canvas:this.state.canvas});this.state.canvas.setActiveObject(e),this.state.canvas.requestRenderAll()}}),10))}))}duplicate(){if(0===this.currentObjects.length)return;const t=this.currentObjects.map((t=>t.toObject()));this.state.canvas.discardActiveObject();const e=[];let s=0;t.forEach((i=>{try{const t=this.createObjectFromData(i);t&&(t.set({left:(t.left||0)+20,top:(t.top||0)+20}),this.state.add(t),e.push(t))}catch(t){console.warn("Failed to duplicate object:",t)}s++,s===t.length&&(this.state.onLayerOrderChanged.forward(),setTimeout((()=>{if(1===e.length)this.state.selectObject(e[0]);else if(e.length>1){const t=new this.state.canvas.constructor.ActiveSelection(e,{canvas:this.state.canvas});this.state.canvas.setActiveObject(t),this.state.canvas.requestRenderAll()}}),10))}))}delete(){0!==this.currentObjects.length&&(this.currentObjects.forEach((t=>{this.state.canvas.remove(t)})),this.state.canvas.discardActiveObject(),this.state.canvas.requestRenderAll(),this.currentObjects=[],this.state.onLayerOrderChanged.forward())}bringToFront(){1===this.currentObjects.length&&(this.state.canvas.bringObjectToFront(this.currentObjects[0]),this.state.canvas.requestRenderAll(),this.state.onLayerOrderChanged.forward())}bringForward(){1===this.currentObjects.length&&(this.state.canvas.bringObjectForward(this.currentObjects[0]),this.state.canvas.requestRenderAll(),this.state.onLayerOrderChanged.forward())}sendBackward(){if(1!==this.currentObjects.length)return;const t=this.currentObjects[0],e=this.state.canvas.getObjects(),s=e.indexOf(this.state.canvas.workspaceBackground);e.indexOf(t)>s+1&&(this.state.canvas.sendObjectBackwards(t),this.state.canvas.requestRenderAll(),this.state.onLayerOrderChanged.forward())}sendToBack(){if(1!==this.currentObjects.length)return;const t=this.currentObjects[0];this.state.canvas.getObjects().indexOf(this.state.canvas.workspaceBackground),this.state.canvas.sendObjectToBack(t);const e=this.state.canvas.getObjects();e.indexOf(t)<=e.indexOf(this.state.canvas.workspaceBackground)&&this.state.canvas.bringObjectForward(t),this.state.canvas.requestRenderAll(),this.state.onLayerOrderChanged.forward()}toggleVisibility(){if(1!==this.currentObjects.length)return;const t=this.currentObjects[0];t.set("visible",!t.visible),this.state.canvas.requestRenderAll(),this.state.onPropertiesChanged.forward(t)}toggleLock(){if(1!==this.currentObjects.length)return;const t=this.currentObjects[0];t.set("selectable",!t.selectable),t.selectable||this.state.canvas.discardActiveObject(),this.state.canvas.requestRenderAll(),this.state.onPropertiesChanged.forward(t)}selectAll(){const t=this.state.canvas.getWorkspaceObjects().filter((t=>t.selectable&&t!==this.state.canvas.backgroundImage&&t!==this.state.canvas.workspaceBackground));if(0!==t.length)if(1===t.length)this.state.selectObject(t[0]);else{this.state.canvas.discardActiveObject();const e=new this.state.canvas.constructor.ActiveSelection(t,{canvas:this.state.canvas});this.state.canvas.setActiveObject(e),this.state.canvas.requestRenderAll()}}destroy(){this.host.removeEventListener("contextmenu",this.onContextMenu),document.removeEventListener("click",this.hide),document.removeEventListener("keydown",this.onKeyDown),this.menu.parentNode&&this.menu.parentNode.removeChild(this.menu)}}class V{static attach(t){const e=new V(t),s=t.canvas.upperCanvasEl,i=t.canvas.getElement();if(s||i){const t=e.state.canvas.findTarget.bind(e.state.canvas);e.state.canvas.findTarget=(s,i)=>e.enhancedFindTarget.call(e,s,i,t)}return e}constructor(t){this.state=t,this.lastClickTime=0,this.lastClickPosition={x:0,y:0},this.clickThreshold=300,this.positionThreshold=5}enhancedFindTarget(e,s=!1,i){if(this.state.mode!==t.EditorMode.select)return i(e,s);try{const t=e;if(!t)return i(e,s);const n=i(e,s),o=this.getObjectsAtPosition(t);if(0===o.length)return n;if(1===o.length){const t=o[0];return n===t||"image"!==t.type?t:n&&"image"!==n.type&&"image"===t.type?n:t}{const t=o[0];return n&&o.includes(n)&&"image"!==n.type?n:t}}catch(t){return console.error("Enhanced selection: Error in enhancedFindTarget",t),i(e,s)}}getObjectsAtPosition(t){const e=this.state.canvas.getPointer(t),s=this.state.canvas.getObjects(),i=[];for(let n=s.length-1;n>=0;n--){const o=s[n];if(o===this.state.canvas.backgroundImage||o===this.state.canvas.workspaceBackground||!o.selectable||!o.visible||2===t.button&&!o.selectable)continue;this.isPointInObject(o,e)&&i.push(o)}return i}isPointInObject(t,e){if("image"===t.type)return this.isPointInImageContent(t,e);if("function"==typeof t.containsPoint)try{const s=t.containsPoint(e);if(!s){const s=t.getBoundingRect();return e.x>=s.left&&e.x<=s.left+s.width&&e.y>=s.top&&e.y<=s.top+s.height}return s}catch(e){console.warn("Enhanced selection: containsPoint error for",t.type,e)}const s=t.getBoundingRect();return e.x>=s.left&&e.x<=s.left+s.width&&e.y>=s.top&&e.y<=s.top+s.height}isPointInImageContent(t,e){var s,i;try{const n=t.getBoundingRect(),o=e.x>=n.left&&e.x<=n.left+n.width&&e.y>=n.top&&e.y<=n.top+n.height;if(!o)return!1;const a=t._element||(null===(i=(s=t).getElement)||void 0===i?void 0:i.call(s));if(!a||!a.complete)return o;const r=this.globalToLocalPoint(t,e);if(!r)return o;const c=a.naturalWidth||a.width,h=a.naturalHeight||a.height;if(r.x<0||r.x>=c||r.y<0||r.y>=h)return!1;const l=a.src||"";if(l.toLowerCase().includes(".png")||l.toLowerCase().includes("data:image/png")){return this.isPixelOpaque(a,Math.floor(r.x),Math.floor(r.y))}return!0}catch(s){console.warn("Enhanced selection: error checking image content",s);const i=t.getBoundingRect();return e.x>=i.left&&e.x<=i.left+i.width&&e.y>=i.top&&e.y<=i.top+i.height}}globalToLocalPoint(t,s){var i,n,o,a,r,c;try{const h=t.calcTransformMatrix(),l=null===(o=null===(n=null===(i=window.fabric)||void 0===i?void 0:i.util)||void 0===n?void 0:n.invertTransform)||void 0===o?void 0:o.call(n,h);if(l){const t=null===(c=null===(r=null===(a=window.fabric)||void 0===a?void 0:a.util)||void 0===r?void 0:r.transformPoint)||void 0===c?void 0:c.call(r,s,l);if(t)return new e.Point(t.x,t.y)}const d=t.getBoundingRect();return new e.Point(s.x-d.left,s.y-d.top)}catch(t){return console.warn("Enhanced selection: error converting point",t),null}}selectBestObject(t,e){if(1===t.length)return t[0];const s=this.state.canvas.getActiveObject();if(e&&s&&t.includes(s)){const e=t.indexOf(s);return t[(e+1)%t.length]}return t[0]}isPixelOpaque(t,e,s){try{const i=document.createElement("canvas"),n=i.getContext("2d");if(!n)return!0;i.width=t.naturalWidth||t.width,i.height=t.naturalHeight||t.height,n.drawImage(t,0,0);const o=n.getImageData(e,s,1,1).data[3];return o>128}catch(t){return console.warn("Enhanced selection: Error sampling pixel data",t),!0}}destroy(){}}class X{static attach(t,e){const s=new X(t,e);return s.setupEventListeners(),s}constructor(t,e){this.state=t,this.dragOverCounter=0,this.onDragOver=t=>{t.preventDefault(),t.stopPropagation(),this.hasImageFiles(t.dataTransfer)&&(t.dataTransfer.dropEffect="copy",this.addDropOverlay())},this.onDragEnter=t=>{t.preventDefault(),t.stopPropagation(),this.dragOverCounter++,this.hasImageFiles(t.dataTransfer)&&this.addDropOverlay()},this.onDragLeave=t=>{t.preventDefault(),t.stopPropagation(),this.dragOverCounter--,0===this.dragOverCounter&&this.removeDropOverlay()},this.onDrop=t=>i(this,void 0,void 0,(function*(){var e;t.preventDefault(),t.stopPropagation(),this.dragOverCounter=0,this.removeDropOverlay();const s=null===(e=t.dataTransfer)||void 0===e?void 0:e.files;if(!s)return;const i=this.state.canvas.getElement().getBoundingClientRect();t.clientX,i.left,t.clientY,i.top;const n=this.state.canvas.getPointer(t);for(let t=0;t<s.length;t++){const e=s[t];this.isImageFile(e)&&(yield this.handleImageFile(e,n.x+10*t,n.y+10*t))}})),this.dropZone=e}setupEventListeners(){this.dropZone.addEventListener("dragover",this.onDragOver),this.dropZone.addEventListener("dragenter",this.onDragEnter),this.dropZone.addEventListener("dragleave",this.onDragLeave),this.dropZone.addEventListener("drop",this.onDrop)}hasImageFiles(t){if(!t)return!1;for(let e=0;e<t.items.length;e++){const s=t.items[e];if("file"===s.kind&&s.type.startsWith("image/"))return!0}return!1}isImageFile(t){return t.type.startsWith("image/")}handleImageFile(t,s,n){return i(this,void 0,void 0,(function*(){try{const i=yield this.fileToDataURL(t),o=yield this.loadImage(i),a=.8*this.state.canvas.workspaceWidth,r=.8*this.state.canvas.workspaceHeight,c=Math.min(a/o.width,r/o.height,1),h=s-o.width*c/2,l=n-o.height*c/2,d=new e.MceImage(o,{left:h,top:l,scaleX:c,scaleY:c,selectable:!0,moveCursor:"move"});this.state.add(d),this.state.selectObject(d),console.log(`Added image: ${t.name} at position (${s}, ${n}) with scale ${c}`)}catch(t){console.error("Failed to add dropped image:",t)}}))}fileToDataURL(t){return new Promise(((e,s)=>{const i=new FileReader;i.onload=()=>e(i.result),i.onerror=()=>s(i.error),i.readAsDataURL(t)}))}loadImage(t){return new Promise(((e,s)=>{const i=new Image;i.onload=()=>e(i),i.onerror=()=>s(new Error("Failed to load image")),i.src=t}))}addDropOverlay(){this.removeDropOverlay();const t=document.createElement("div");t.id="mce-drop-overlay",t.style.cssText="\n\t\t\tposition: absolute;\n\t\t\ttop: 0;\n\t\t\tleft: 0;\n\t\t\tright: 0;\n\t\t\tbottom: 0;\n\t\t\tbackground: rgba(74, 144, 226, 0.1);\n\t\t\tborder: 2px dashed #4a90e2;\n\t\t\tborder-radius: 8px;\n\t\t\tdisplay: flex;\n\t\t\talign-items: center;\n\t\t\tjustify-content: center;\n\t\t\tz-index: 1000;\n\t\t\tpointer-events: none;\n\t\t\tfont-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;\n\t\t\tfont-size: 18px;\n\t\t\tfont-weight: 600;\n\t\t\tcolor: #4a90e2;\n\t\t\ttext-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);\n\t\t",t.textContent="Drop images here",this.dropZone.style.position="relative",this.dropZone.appendChild(t)}removeDropOverlay(){const t=document.getElementById("mce-drop-overlay");t&&t.remove()}destroy(){this.removeDropOverlay(),this.dropZone.removeEventListener("dragover",this.onDragOver),this.dropZone.removeEventListener("dragenter",this.onDragEnter),this.dropZone.removeEventListener("dragleave",this.onDragLeave),this.dropZone.removeEventListener("drop",this.onDrop)}}function $(){const t=n.div({class:"mce-workspace"}),e=document.createElement("canvas");return e.width=1,e.height=1,t.appendChild(e),{view:t,nativeCanvas:e}}const z={imageSmoothingEnabled:!0,preserveObjectStacking:!0,controlsAboveOverlay:!0,enableRetinaScaling:!0,skipOffscreen:!0};class G{static createBlank(t,s,i){const{view:n,nativeCanvas:o}=$(),a=e.MceCanvas.createBlank(t,s,o,z);return G.create(n,a,i)}static createFromJSON(t,s){return i(this,void 0,void 0,(function*(){const{view:i,nativeCanvas:n}=$(),o=yield e.MceCanvas.createFromJSON(t,n,z);return G.create(i,o,s)}))}static create(e,s,i){const n=i.initialMode||t.EditorMode.select,o=new A(s,n,i,e),a=new G(e,s,o);return s.on("mouse:wheel",a.onWheel),o.onModeChanged.subscribe(a.reloadMode),a.reloadMode(),a.contextMenu=Y.attach(o,e),a.enhancedSelection=V.attach(o),a.imageDropHandler=X.attach(o,e),a}constructor(t,s,i){this.view=t,this.canvas=s,this.state=i,this.reloadLayout=()=>{if(!this.view.parentElement)throw new Error("Workspace is not attached to the DOM");this.canvas.setWidth(this.view.clientWidth),this.canvas.setHeight(this.view.clientHeight)},this.onWheel=t=>{t.e.preventDefault(),t.e.stopPropagation();const s=t.e.deltaY;let i=this.canvas.getZoom();i*=Math.pow(.999,s),i>20&&(i=20),i<.01&&(i=.01),this.canvas.zoomToPoint(new e.Point(t.e.offsetX,t.e.offsetY),i),this.state.onZoomChanged.forward()},this.reloadMode=()=>{this.currentMode&&this.currentMode.destroy(),this.currentMode=N.get(this.state.mode,this.state),this.currentMode.init()}}startAutoLayout(t){setTimeout((()=>{this.reloadLayout(),t&&this.state.center()})),window.addEventListener("resize",this.reloadLayout,!1)}destroy(){return i(this,void 0,void 0,(function*(){this.currentMode&&this.currentMode.destroy(),this.contextMenu&&this.contextMenu.destroy(),this.enhancedSelection&&this.enhancedSelection.destroy(),this.imageDropHandler&&this.imageDropHandler.destroy(),window.removeEventListener("resize",this.reloadLayout,!1),yield this.canvas.dispose()}))}}class J{static create(t,e,s){const i=n.div({class:"mce-toolbox-item",title:e});i.appendChild(a.createSvg(t,"mce-toolbox-item-icon"));const o=new J(i,s);return i.addEventListener("click",(t=>{t.preventDefault(),o.onClicked.forward(o)}),!1),o}constructor(t,e){this.view=t,this.mode=e,this.onClicked=new r}setIsSelected(t){this.view.classList.toggle("mce-selected",t)}}class K{static create(t){const e=n.div({class:"mce-toolbox-item",title:"Zoom / Center"}),s=n.div({class:"mce-toolbox-item-zoom"});e.appendChild(s);const i=new K(e,s,t);return e.addEventListener("click",i.onClick,!1),i.reloadZoom(),t.onZoomChanged.subscribe(i.reloadZoom),i}constructor(t,e,s){this.view=t,this.text=e,this.state=s,this.reloadZoom=()=>{const t=Math.round(100*this.state.canvas.getZoom());this.text.innerText=`${t}%`},this.onClick=()=>{this.state.center(),this.reloadZoom()}}}function _(t){return i(this,void 0,void 0,(function*(){const s=yield new Promise((t=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.addEventListener("change",(()=>{if(e.files&&e.files.length>0){const s=e.files[0],i=new FileReader;i.onload=()=>{const e=new Image;e.onload=()=>{t(e)},e.src=i.result},i.readAsDataURL(s)}else t(null)})),e.click()}));if(s){const i=Math.max(s.width/t.canvas.workspaceWidth,s.height/t.canvas.workspaceHeight),n=new e.MceImage(s,{left:0,top:0,width:s.width,height:s.height,scaleX:1/i,scaleY:1/i});t.add(n)}}))}class Q{static create(e,s){const i=n.div({class:"mce-toolbox"}),o=n.div({class:"mce-toolbox-top"}),r=n.div({class:"mce-toolbox-bottom"});i.appendChild(o),i.appendChild(r);let c=null;const h=[J.create(a.cursor,"Select",t.EditorMode.select),!1!==s.hand&&J.create(a.hand,"Hand",t.EditorMode.hand),!1!==s.rect&&J.create(a.rect,"Rect",t.EditorMode.rect),!1!==s.circle&&J.create(a.circle,"Circle",t.EditorMode.circle),!1!==s.textbox&&J.create(a.text,"Textbox",t.EditorMode.textbox),!1!==s.brush&&J.create(a.brush,"Brush",t.EditorMode.brush),!1!==s.image&&(c=J.create(a.image,"Image",null))].filter(Boolean),l=new Q(i,e,h);for(const t of h)o.appendChild(t.view),t.mode&&t.onClicked.subscribe(l.onItemClicked);c&&c.onClicked.subscribe(l.onOpenImageClicked);const d=K.create(e);return r.appendChild(d.view),l.reloadSelection(),e.onModeChanged.subscribe(l.reloadSelection),l}constructor(t,e,s){this.view=t,this.state=e,this.items=s,this.onItemClicked=t=>{t.mode&&this.state.setMode(t.mode)},this.onOpenImageClicked=()=>i(this,void 0,void 0,(function*(){_(this.state)})),this.reloadSelection=()=>{this.items.forEach((t=>t.setIsSelected(t.mode===this.state.mode)))}}}class tt{static create(t){const e=new tt(t);return window.addEventListener("resize",e.reload,!1),e.reload(),e}constructor(t){this.root=t,this.reload=()=>{this.root.clientWidth<400?this.root.classList.add("mce-mobile"):this.root.classList.remove("mce-mobile")}}destroy(){window.removeEventListener("resize",this.reload,!1)}}function et(t,e){const s=new r,i=n.element("span",{class:"mce-toolbar-label"});i.textContent=t;const o=n.element("input",{class:"mce-toolbar-color-input",type:"color",value:e});o.addEventListener("change",(function(){s.forward(o.value)}),!1);const a=n.div({class:"mce-toolbar-item"});return a.appendChild(i),a.appendChild(o),{view:a,onChanged:s}}class st{static create(t){const e=n.div({class:"mce-toolbar-brush"}),s=et("Fill",t.rect.fillColor);e.appendChild(s.view);const i=new st(e,t);return s.onChanged.subscribe(i.onFillColorChanged),i}constructor(t,e){this.view=t,this.state=e,this.onFillColorChanged=t=>{this.state.brush.brushColor=t,this.state.onBrushConfigurationChanged.forward()}}destroy(){}}class it{static create(t){const e=n.div({class:"mce-toolbar-circle"}),s=et("Fill",t.circle.fillColor);e.appendChild(s.view);const i=new it(e,t);return s.onChanged.subscribe(i.onFillColorChanged),i}constructor(t,e){this.view=t,this.state=e,this.onFillColorChanged=t=>{this.state.circle.fillColor=t,this.state.onBrushConfigurationChanged.forward()}}destroy(){}}class nt{static create(t){const e=n.div({class:"mce-toolbar-brush"}),s=function(t,e){const s=new r,i=n.element("span",{class:"mce-toolbar-label"});i.textContent=t;const o=n.element("input",{class:"mce-toolbar-number-input",type:"number",min:"0.5",step:"0.5",value:String(e)});o.addEventListener("change",(function(){const t=Number(o.value);s.forward(t)}),!1);const a=n.div({class:"mce-toolbar-item"});return a.appendChild(i),a.appendChild(o),{view:a,onChanged:s}}("Size",t.brush.brushSize),i=et("Color",t.brush.brushColor);e.appendChild(s.view),e.appendChild(i.view);const o=new nt(e,t);return s.onChanged.subscribe(o.onBrushSizeChanged),i.onChanged.subscribe(o.onBrushColorChanged),o}constructor(t,e){this.view=t,this.state=e,this.onBrushSizeChanged=t=>{this.state.brush.brushSize=t,this.state.onBrushConfigurationChanged.forward()},this.onBrushColorChanged=t=>{this.state.brush.brushColor=t,this.state.onBrushConfigurationChanged.forward()}}destroy(){}}class ot{static create(e,s){switch(e){case t.EditorMode.rect:return st.create(s);case t.EditorMode.circle:return it.create(s);case t.EditorMode.brush:return nt.create(s)}return null}}class at{static create(t){const e=n.div({class:"mce-toolbar"}),s=new at(e,t);return t.onModeChanged.subscribe(s.reload),s.reload(),s}constructor(t,e){this.view=t,this.state=e,this.current=null,this.reload=()=>{this.current&&(this.view.removeChild(this.current.view),this.current=null);const t=ot.create(this.state.mode,this.state);t?(this.current=t,this.view.appendChild(this.current.view),this.view.classList.remove("mce-hidden")):this.view.classList.add("mce-hidden")}}destroy(){this.current&&this.current.destroy()}}class rt{constructor(t,e){this.state=t,this.container=e,this.spacePressed=!1,this.isHandTemporary=!1,this.onKeyDown=t=>{if(!this.isInputFocused())switch(t.key){case" ":this.spacePressed||this.isHandTemporary||(t.preventDefault(),this.spacePressed=!0,this.enterTemporaryHandMode());break;case"Delete":case"Backspace":t.preventDefault(),this.deleteSelectedObjects();break;case"ArrowUp":t.preventDefault(),this.moveSelectedObjects(0,-this.getMoveStep(t));break;case"ArrowDown":t.preventDefault(),this.moveSelectedObjects(0,this.getMoveStep(t));break;case"ArrowLeft":t.preventDefault(),this.moveSelectedObjects(-this.getMoveStep(t),0);break;case"ArrowRight":t.preventDefault(),this.moveSelectedObjects(this.getMoveStep(t),0);break;case"a":case"A":(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.selectAllObjects());break;case"Escape":t.preventDefault(),this.clearSelection()}},this.onKeyUp=t=>{if(!this.isInputFocused()&&" "===t.key)this.spacePressed&&(this.spacePressed=!1,this.exitTemporaryHandMode())},this.container.addEventListener("keydown",this.onKeyDown,!0),this.container.addEventListener("keyup",this.onKeyUp,!0),this.container.hasAttribute("tabindex")||this.container.setAttribute("tabindex","0")}destroy(){this.container.removeEventListener("keydown",this.onKeyDown,!0),this.container.removeEventListener("keyup",this.onKeyUp,!0)}isInputFocused(){const t=document.activeElement;if(!t)return!1;const e=t.tagName.toLowerCase();return"input"===e||"textarea"===e||"select"===e||t.hasAttribute("contenteditable")}getMoveStep(t){return t.shiftKey?10:1}deleteSelectedObjects(){const t=this.state.canvas.getActiveObjects();0!==t.length&&(t.forEach((t=>{this.state.canvas.remove(t)})),this.state.canvas.discardActiveObject(),this.state.canvas.requestRenderAll())}moveSelectedObjects(t,e){const s=this.state.canvas.getActiveObjects();0!==s.length&&(s.forEach((s=>{const i=s.left||0,n=s.top||0;s.set({left:i+t,top:n+e}),s.setCoords()})),this.state.canvas.requestRenderAll())}selectAllObjects(){const e=this.state.canvas.getWorkspaceObjects();0!==e.length&&(this.state.mode!==t.EditorMode.select&&this.state.setMode(t.EditorMode.select),e.length>0&&this.state.canvas.setActiveObject(e[0]),this.state.canvas.requestRenderAll())}clearSelection(){this.state.canvas.discardActiveObject(),this.state.canvas.requestRenderAll()}enterTemporaryHandMode(){this.state.mode!==t.EditorMode.hand&&(this.previousMode=this.state.mode,this.isHandTemporary=!0,this.state.setMode(t.EditorMode.hand))}exitTemporaryHandMode(){this.isHandTemporary&&this.previousMode&&(this.isHandTemporary=!1,this.state.setMode(this.previousMode),this.previousMode=void 0)}}class ct{static createBlank(t,e,s,i){const n=G.createBlank(e,s,i);return ct.create(t,n,i)}static createFromImage(t,s,i,n){var o,a,r;const c=null!==(o=i.workspaceWidth)&&void 0!==o?o:s.width,h=null!==(a=i.workspaceHeight)&&void 0!==a?a:s.height,l=ct.createBlank(t,c,h,n),d={width:s.width,height:s.height,selectable:null===(r=i.selectable)||void 0===r||r};if(i.fitToWorkspace){const t=Math.max(c/s.width,h/s.height);d.left=(c-s.width*t)/2,d.top=(h-s.height*t)/2,d.scaleX=t,d.scaleY=t}const u=new e.MceImage(s,d);if(l.add(u),!1===i.selectable&&i.select)throw new Error("Cannot select an image that is not selectable");return!1!==i.selectable&&i.select&&l.state.canvas.setActiveObject(u),l}static createFromJSON(t,e,s){return i(this,void 0,void 0,(function*(){const i=yield G.createFromJSON(t,s);return ct.create(e,i,s)}))}static create(t,e,s){const i=n.div({class:"mce-editor"}),o=e.state,a=Q.create(o,s),r=at.create(o);if(i.appendChild(a.view),i.appendChild(r.view),i.appendChild(e.view),!1!==s.sidebar){const t=L.create(o,"object"==typeof s.sidebar?s.sidebar:{});i.appendChild(t.view)}t.appendChild(i),e.startAutoLayout(!0);const c=tt.create(i),h=new ct(i,e,o,c);return o.initHistory(),o.canvas.on("object:added",h.onAnyChange),o.canvas.on("object:modified",h.onAnyChange),o.canvas.on("object:moving",h.onAnyChange),o.canvas.on("object:removed",h.onAnyChange),o.canvas.on("object:resizing",h.onAnyChange),o.canvas.on("object:rotating",h.onAnyChange),o.canvas.on("object:scaling",h.onAnyChange),o.canvas.on("object:skewing",h.onAnyChange),o.canvas.on("text:changed",h.onAnyChange),o.canvas.on("text:editing:exited",h.onAnyChange),o.canvas.on("selection:cleared",h.onAnyChange),o.canvas.on("selection:created",h.onAnyChange),o.canvas.on("selection:updated",h.onAnyChange),o.onLayerOrderChanged.subscribe(h.onAnyChange),o.onPropertiesChanged.subscribe(h.onAnyChange),h}constructor(t,e,s,i){this.view=t,this.workspace=e,this.state=s,this.layoutController=i,this.onChanged=new r,this.onAnyChange=()=>{this.onChanged.forward()},this.keyboardShortcuts=new rt(this.state,this.view)}getWidth(){return this.state.canvas.workspaceWidth}getHeight(){return this.state.canvas.workspaceHeight}getWorkspaceObjects(){return this.state.canvas.getWorkspaceObjects()}add(t){this.state.add(t)}toJSON(){return this.state.canvas.toImageJSON()}cloneToStaticCanvas(){return e.MceStaticCanvas.createFromJSON(this.toJSON())}undo(){this.state.undo()}redo(){this.state.redo()}render(){const t=this.state.canvas.getZoom(),s=this.state.canvas.width,i=this.state.canvas.height,n=this.state.canvas.viewportTransform,o=this.state.canvas.getActiveObjects().map((t=>{const e=t.controls,s=t.hasBorders;return t.controls={},t.hasBorders=!1,{object:t,controls:e,hasBorders:s}}));this.state.canvas.setWidth(this.state.canvas.workspaceWidth),this.state.canvas.setHeight(this.state.canvas.workspaceHeight),this.state.canvas.setZoom(1),this.state.canvas.absolutePan(new e.Point(0,0)),this.state.canvas.workspaceBackground.visible=!1;const a=this.state.canvas.toCanvasElement(1,{left:0,top:0,width:this.state.canvas.workspaceWidth,height:this.state.canvas.workspaceHeight});return this.state.canvas.setZoom(t),this.state.canvas.setWidth(s),this.state.canvas.setHeight(i),this.state.canvas.setViewportTransform(n),this.state.canvas.workspaceBackground.visible=!0,o.forEach((({object:t,controls:e,hasBorders:s})=>{t.controls=e,t.hasBorders=s})),a}destroy(){var t;return i(this,void 0,void 0,(function*(){this.keyboardShortcuts.destroy(),yield this.workspace.destroy(),this.layoutController.destroy(),null===(t=this.view.parentElement)||void 0===t||t.removeChild(this.view)}))}}t.Editor=ct}));
